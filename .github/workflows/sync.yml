name: Upstream Sync

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0 * * *" # 每天北京时间早8点
  workflow_dispatch:

jobs:
  sync_latest_from_upstream:
    runs-on: ubuntu-latest
    name: Sync latest commits from upstream repo

    steps:
    - name: Checkout target repo
      uses: actions/checkout@v3
      with:
        # 必须拉取全部历史，否则无法 merge
        fetch-depth: 0

    - name: Sync Upstream
      uses: actions/github-script@v6
      with:
        script: |
          const upstream_repo = "ZhuLinsen/daily_stock_analysis";
          const branch = "main"; // 如果原作者是 master，这里改 master

          try {
            // 1. 配置 Git 身份
            await exec.exec("git config --global user.name 'GitHub Actions'");
            await exec.exec("git config --global user.email 'actions@github.com'");

            // 2. 添加上游仓库并拉取
            await exec.exec(`git remote add upstream https://github.com/${upstream_repo}.git`);
            await exec.exec("git fetch upstream");

            // 3. 尝试合并 (关键步骤)
            // --no-edit: 使用默认合并信息
            // 这一步会把你依然保留 sync.yml 的同时，把上游新代码合进来
            try {
              await exec.exec(`git merge upstream/${branch} --no-edit`);
            } catch (error) {
              console.log("Merge conflict or error, trying to resolve...");
              // 如果只是普通的冲突，有时候需要策略，但对于 sync 脚本通常只要合并即可
              // 如果这里失败，通常意味着原作者改了和我不一样的核心文件，几率很小
              throw error;
            }

            // 4. 推送回你的仓库
            await exec.exec("git push origin");
            console.log("✅ 同步成功！");
            
          } catch (error) {
            console.error("❌ 同步失败:", error);
            core.setFailed(error.message);
          }
