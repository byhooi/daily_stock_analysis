name: Upstream Sync

permissions:
  contents: write
  workflows: write

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  sync_latest_from_upstream:
    runs-on: ubuntu-latest
    name: Sync latest commits from upstream repo

    steps:
      - name: Checkout target repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Sync Upstream
        uses: actions/github-script@v6
        with:
          script: |
            const upstream_repo = "ZhuLinsen/daily_stock_analysis";
            const branch = "main";
            
            try {
              await exec.exec("git config --global user.name 'GitHub Actions'");
              await exec.exec("git config --global user.email 'actions@github.com'");
              
              await exec.exec(`git remote add upstream https://github.com/${upstream_repo}.git`);
              await exec.exec("git fetch upstream");
              await exec.exec(`git checkout ${branch}`);
              
              try {
                console.log("尝试合并上游代码...");
                await exec.exec(`git merge upstream/${branch} -X theirs --allow-unrelated-histories --no-edit`);
              } catch (error) {
                console.error("合并失败，输出状态...");
                await exec.exec("git status");
                throw error;
              }
              
              await exec.exec("git push origin");
              console.log("✅ 同步成功！");
            } catch (error) {
              console.error("❌ 同步失败:", error);
              core.setFailed(error.message);
            }
